name: Deploy Matrix Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker compose config -q

      - name: Prepare production deployment configuration
        run: |
          echo "üìù Using latest image tags for production deployment"
          echo "üí° Latest tags are kept in sync with main branch by build workflow"
          
          # Verify the compose file works
          docker compose config --quiet
          
          echo "‚úÖ Configuration validated for production deployment"
          
      - name: Update deployment branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Create or checkout deploy branch  
          git checkout -B deploy
          
          # Copy the main configuration to deploy branch
          git add .
          git commit -m "ci: Update deployment configuration - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
          
          # Push to deploy branch
          git push origin deploy --force

      - name: Trigger Portainer Redeploy Webhook
        if: ${{ vars.PORTAINER_REDEPLOY_HOOK != '' }}
        uses: distributhor/workflow-webhook@v3
        with:
          webhook_url: ${{ vars.PORTAINER_REDEPLOY_HOOK }}
          webhook_secret: "trigger"
        continue-on-error: true

      - name: Notify deployment status
        env:
          PORTAINER_REDEPLOY_HOOK: ${{ vars.PORTAINER_REDEPLOY_HOOK || '' }}
        run: |
          echo "üöÄ Deployment completed successfully"
          echo "üìù Configuration updated in deploy branch"
          if [ -n "$PORTAINER_REDEPLOY_HOOK" ]; then
            echo "üîÑ Portainer webhook triggered"
          else
            echo "‚ö†Ô∏è  Portainer webhook not configured"
          fi